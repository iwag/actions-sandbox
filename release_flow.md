# Release Flow (main + release/candidate)

## Purpose

Define the release procedure for repositories that use `main` as the single integration branch and maintain a persistent release-candidate branch (`release/candidate`).
This document describes:

* branch responsibilities
* automated steps performed by GitHub Actions
* manual steps required for preparing and shipping a release
* where release notes live and how they are exposed in GitHub

## Branch Model

### Branches

| Branch              | Role                                                                |
| ------------------- | ------------------------------------------------------------------- |
| `main`              | Integration branch. All development changes land here via PR.       |
| `release/candidate` | Persistent branch representing the current release candidate state. |

### Rules

* Feature/fix branches must be created from `main`.
* Direct commits to `release/candidate` are not allowed.
* If a change is needed for the release, merge it into `main` first; `release/candidate` is updated only via the release PR.

## Overview

1. PRs are merged into `main` (normal development flow).
2. On merge to `main`, a GitHub Actions workflow creates/updates a release PR from `main` to `release/candidate`.
3. A human reviews the release PR and merges it if acceptable. This advances `release/candidate`.
4. When ready to ship, a human triggers a workflow that:

   * creates a tag on `release/candidate`
   * creates a GitHub Release entry for that tag

## Automated Workflows

### Workflow A: Create release PR (main → release/candidate)

Triggered on: `pull_request.closed` targeting `main` (only when merged).

Actions:

* Ensure `release/candidate` exists.

  * If absent, create it from `origin/main` and push.
* Run `git-pr-release` to create/update a PR:

  * base: `release/candidate`
  * head: `main`
  * labels: `pr-release`, `skip review`
  * body: generated using `.github/GIT_RELEASE_PR_TEMPLATE.html.erb`

Output:

* A PR titled like `Release <timestamp>` created by `github-actions`:

  * “merge N commits into release/candidate from main”
  * PR body contains the release notes candidate.

Notes:

* This PR is expected and is the mechanism to move `release/candidate` forward.
* Do not close this PR; closing means `release/candidate` will not be updated.

### Workflow B: Create release tag (+ GitHub Release)

Triggered on: manual (`workflow_dispatch`).

Inputs:

* `tag`: release identifier (e.g. `v1.2.3`)

Actions:

* Checkout `release/candidate`.
* Create and push the provided git tag.
* Create a GitHub Release for the tag (notes are generated automatically at minimum level).

Output:

* Git tag pointing to the exact commit on `release/candidate` at the time of tagging.
* A GitHub Release entry visible under the repository’s “Releases” page.

## Release Notes

### Source of truth

* The release PR body (generated by `git-pr-release`) is treated as the primary release-notes draft for review.

### GitHub visibility

* The GitHub Release created at tagging time makes the release visible in the GitHub UI (“Releases” page).
* The minimum implementation uses auto-generated notes; if needed later, we can populate the GitHub Release body from the release PR body.

## Procedures

### Normal change flow

1. Create branch from `main`.
2. Open PR to `main`.
3. Merge after review.

### Preparing the release candidate

1. After merges into `main`, confirm a release PR exists (created by workflow A).
2. Review the release PR:

   * verify expected changes are included
   * verify release notes content is acceptable
3. Merge the release PR.

   * This updates `release/candidate` to the reviewed state.

### Shipping a release (tagging)

Precondition:

* The latest release PR has been merged and `release/candidate` represents the intended release commit.

Steps:

1. Run workflow B (“Create release tag”).
2. Provide a tag name in `v0.0.0` format (e.g. `v1.2.3`).
3. Confirm the GitHub Release appears under “Releases”.

## FAQ / Operational Notes

### Why does a PR appear after merging to main?

It is created by automation to apply the reviewed set of `main` changes onto `release/candidate`. This is the expected mechanism for progressing the release candidate.

### What if a change is required after a release PR is created?

Merge the fix into `main`. A subsequent release PR update/run will include it. Do not patch `release/candidate` directly.

### What if the release PR is not merged but a tag is created?

The tag will point to an older `release/candidate` commit. Always merge the current release PR before tagging.

### What does “tag ↔ branch binding” mean here?

Tags reference commits, not branches. By checking out `release/candidate` during tagging, the tag points to the current `release/candidate` commit, which is the effective binding.
